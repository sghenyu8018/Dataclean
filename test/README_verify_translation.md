# 翻译验证脚本使用文档

## 概述

`verify_translation.py` 是一个用于验证翻译质量的脚本。它从JSONL文件中提取中文和译文，在TSV文件中查找匹配的中文，并比较JSONL中的译文与TSV中的源语言文本是否一致。

## 功能特性

- ✅ 从JSONL文件中提取指定行或所有行的翻译数据
- ✅ 自动检测目标语言（从user消息中提取）
- ✅ 在TSV文件中精确匹配中文
- ✅ 支持多种语言（西班牙语、法语、德语、俄语、日语等）
- ✅ 比较译文一致性
- ✅ 生成详细的统计报告
- ✅ 支持静默模式（只显示统计信息）

## 安装要求

无需额外安装，脚本使用Python标准库：
- `json` - JSON解析
- `csv` - TSV文件读取
- `re` - 正则表达式
- `argparse` - 命令行参数解析
- `pathlib` - 路径处理

## 文件格式

### JSONL文件格式

每行一个JSON对象，包含对话消息：

```json
{
  "messages": [
    {"role": "system", "content": "你是一个专业的新闻领域的翻译大模型..."},
    {"role": "user", "content": "用西班牙语怎么说：如果二人以埃及祖玛..."},
    {"role": "assistant", "content": "Si la pareja se mostró ardiente..."}
  ]
}
```

### TSV文件格式

Tab分隔的两列文件：
- 第一列：源语言文本（如西班牙语、法语等）
- 第二列：中文翻译

示例：
```
Si la pareja se mostró ardiente...	如果二人以埃及祖玛...
```

## 使用方法

### 基本用法

#### 1. 分析指定行（自动检测语言）

```bash
python test/verify_translation.py --lines 3957,3958
```

自动检测目标语言，并在对应的TSV文件中查找：
- 检测到"西班牙语" → 在 `es-zh.tsv` 中查找
- 检测到"法语" → 在 `fr-zh.tsv` 中查找

#### 2. 分析所有行（静默模式）

```bash
python test/verify_translation.py --quiet
```

处理所有行，只显示统计信息，适合快速查看整体情况。

#### 3. 分析所有行（详细模式）

```bash
python test/verify_translation.py
```

不指定 `--lines` 参数，处理所有行并显示详细信息。

### 高级用法

#### 4. 在所有TSV文件中查找

```bash
python test/verify_translation.py --lines 3957 --search-all
```

忽略语言检测，在所有TSV文件中查找匹配的中文。可能找到多条匹配（不同语言）。

#### 5. 指定行号范围

```bash
# 范围格式
python test/verify_translation.py --lines 3957-3960

# 混合格式
python test/verify_translation.py --lines 3957,3958,3960-3965
```

#### 6. 保存结果到文件

```bash
python test/verify_translation.py --quiet --output results.txt
```

#### 7. 自定义文件路径

```bash
# 自定义JSONL文件
python test/verify_translation.py --jsonl 其他文件.jsonl

# 自定义TSV目录
python test/verify_translation.py --tsv-dir ./other_tsv_files

# 指定单个TSV文件
python test/verify_translation.py --tsv tsvfile/news-commentary-v18.es-zh.tsv
```

## 命令行参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--lines` | 要处理的行号，格式：`3957,3958` 或 `3957-3958`。不指定则处理所有行 | 无（处理所有行） |
| `--jsonl` | JSONL文件路径 | `翻译数据集_de_en_fr_es_ja_ru_20260206.jsonl` |
| `--tsv-dir` | TSV文件目录路径 | `tsvfile` |
| `--tsv` | 单个TSV文件路径（如果指定，忽略--tsv-dir） | 无 |
| `--auto-detect-language` | 自动检测目标语言并在对应的TSV文件中查找 | 启用 |
| `--search-all` | 在所有TSV文件中查找（忽略自动检测语言） | 禁用 |
| `--output` | 输出结果到文件 | 无 |
| `--quiet` | 静默模式，只输出统计信息 | 禁用 |
| `--help` | 显示帮助信息 | - |

## 输出说明

### 详细模式输出

```
================================================================================
处理第 3957 行 (1/2)
================================================================================
提取的中文: 如果二人以埃及祖玛和约旦佩特拉为背景在镜头前任人拍照...
检测到的目标语言: 西班牙语
JSONL中的译文: Si la pareja se mostró ardiente ante las cámaras...

步骤2: 在TSV文件中查找匹配的中文...
[OK] 找到 1 条匹配记录

匹配记录 1 (TSV第 981 行 (news-commentary-v18.es-zh.tsv)):
TSV中的源语言文本: Si la pareja se mostró ardiente ante las cámaras...
[OK] 译文完全一致！
```

### 统计信息

```
================================================================================
统计信息
================================================================================
总处理行数: 2
在TSV中找到匹配: 2 (100.00%)
译文完全一致: 2 (100.00%)
译文不一致: 0 (0.00%)
未在TSV中找到: 0 (0.00%)
匹配率（在找到的记录中）: 100.00%
================================================================================
```

## 支持的语言

脚本支持以下语言（自动检测）：

- 英语 (en)
- 德语 (de)
- 法语 (fr)
- 西班牙语 (es)
- 意大利语 (it)
- 葡萄牙语 (pt)
- 俄语 (ru)
- 日语 (ja)
- 阿拉伯语 (ar)
- 印地语 (hi)
- 印尼语 (id)
- 荷兰语 (nl)
- 捷克语 (cs)
- 哈萨克语 (kk)
- 以及其他多种语言

## 工作流程

1. **加载JSONL文件**：读取指定行或所有行
2. **提取信息**：
   - 从user消息中提取中文（去除前缀）
   - 从user消息中提取目标语言（如"西班牙语"）
   - 从assistant消息中提取译文
3. **查找匹配**：
   - 根据目标语言选择对应的TSV文件（如 `es-zh.tsv`）
   - 在TSV文件的第二列（中文列）中精确匹配
4. **比较译文**：
   - 比较JSONL中的译文与TSV中的源语言文本
   - 判断是否完全一致
5. **生成报告**：输出详细结果和统计信息

## 使用示例

### 示例1：快速检查特定行

```bash
python test/verify_translation.py --lines 3957,3958
```

### 示例2：批量验证所有翻译

```bash
# 静默模式，只查看统计
python test/verify_translation.py --quiet --output verification_report.txt
```

### 示例3：查找所有可能的匹配

```bash
# 在所有TSV文件中查找（可能找到不同语言的匹配）
python test/verify_translation.py --lines 3957 --search-all
```

### 示例4：验证特定语言范围

```bash
# 验证第1000-2000行的翻译
python test/verify_translation.py --lines 1000-2000
```

## 注意事项

1. **文件路径**：脚本默认在项目根目录查找文件，确保文件路径正确
2. **编码问题**：TSV文件支持多种编码（UTF-8、GBK等），脚本会自动尝试
3. **匹配方式**：使用精确匹配，中文必须完全一致才会匹配
4. **性能考虑**：
   - 处理所有7000行可能需要较长时间
   - 建议先用小范围测试（如 `--lines 1-100`）
   - 使用 `--quiet` 模式可以加快速度
5. **TSV文件大小**：某些TSV文件可能很大（几十万行），查找需要时间

## 常见问题

### Q: 为什么找不到匹配？

A: 可能的原因：
- TSV文件中没有完全相同的中文
- 中文文本有细微差异（标点、空格等）
- 目标语言检测失败，使用了错误的TSV文件

### Q: 如何查看详细的差异信息？

A: 不使用 `--quiet` 模式，脚本会显示详细的差异信息，包括：
- 长度差异
- 差异位置
- 不同的字符片段

### Q: 可以同时验证多种语言吗？

A: 可以。脚本会自动检测每条记录的目标语言，并在对应的TSV文件中查找。如果使用 `--search-all`，会在所有TSV文件中查找。

### Q: 如何只验证特定语言？

A: 可以先用其他工具过滤JSONL文件，只保留特定语言的记录，然后使用本脚本验证。

## 技术细节

### 中文提取

脚本使用正则表达式去除user消息中的前缀：
- "用XX语怎么说："
- "请把这段话翻译成XX语："
- "将以下内容翻译为XX语："
- "作为...，请将以下内容翻译为XX语："
- "请以...的口吻，将这段话翻译成XX语："
- "帮我翻译成XX语："

### 语言检测

从user消息中提取语言名称（如"西班牙语"），然后映射到语言代码（如"es"），最后查找对应的TSV文件（如 `es-zh.tsv`）。

### 匹配算法

- 使用精确字符串匹配
- 去除首尾空白字符
- 在TSV文件的第二列（中文列）中查找

### 比较算法

- 去除首尾空白字符
- 逐字符比较
- 如果长度相同，显示差异位置
- 如果长度不同，显示长度差异

## 更新日志

- **v1.0** (2024-02-06)
  - 初始版本
  - 支持指定行号验证
  - 支持自动语言检测
  - 支持多TSV文件查找
  - 支持静默模式和结果输出

## 许可证

本脚本是项目的一部分，遵循项目的许可证。
